name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # ðŸš« ÐÐ• ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ NDK Ñ‡ÐµÑ€ÐµÐ· SDK â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ standalone
      - name: Set up Android SDK (without NDK)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "11076708"
          packages: |
            platforms;android-33
            build-tools;33.0.2

      # âœ… Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ standalone NDK â€” Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² CI
      - name: Download Android NDK r25b (standalone)
        run: |
          curl -L https://github.com/android/ndk/releases/download/ndk-r25b/android-ndk-r25b-windows.zip -o ndk.zip
          7z x ndk.zip -o. -y
        shell: cmd

      # âœ… Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ environment.json, ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚, Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼
      - name: Prepare environment.json
        run: |
          $ndkPath = "$(Get-Location)\android-ndk-r25b"
          $sdkPath = "C:\Android\android-sdk"
          $javaPath = "${{ runner.tool_cache }}\Java_Temurin-Hotspot_jdk\17.0.17-10\x64"

          if (-not (Test-Path environment.json)) {
            $json = @{ Android = @{ NDK = $ndkPath; SDK = $sdkPath; Java = $javaPath } }
          } else {
            $json = Get-Content environment.json | ConvertFrom-Json
            if (-not $json.Android) { $json | Add-Member -NotePropertyName Android -NotePropertyValue @{} }
            $json.Android.NDK = $ndkPath
            $json.Android.SDK = $sdkPath
            $json.Android.Java = $javaPath
          }
          $json | ConvertTo-Json -Depth 10 | Set-Content environment.json
        shell: pwsh

      # ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, Ñ‡Ñ‚Ð¾ clang++.exe Ð½Ð° Ð¼ÐµÑÑ‚Ðµ
      - name: Verify standalone NDK
        run: |
          if not exist "android-ndk-r25b\toolchains\llvm\prebuilt\windows-x86_64\bin\clang++.exe" (
            echo ERROR: clang++.exe not found in standalone NDK!
            exit /b 1
          )
          echo NDK OK

      - name: Verify tools
        shell: cmd
        run: |
          if not exist "BuildToolCpp.exe" exit /b 1
          if not exist "[BUILD]BuildEngine[Android].bat" exit /b 1

      - name: Run Android build
        shell: cmd
        run: |
          call "[BUILD]BuildEngine[Android].bat"

      - name: Find APK
        id: find_apk
        shell: cmd
        run: |
          for /r %%i in (*.apk) do (
            echo APK_PATH=%%i
            echo APK_PATH=%%i>>%GITHUB_ENV%
            goto :done
          )
          echo ERROR: APK not found!
          exit /b 1
          :done

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: game-apk
          path: ${{ env.APK_PATH }}
