name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "11076708"
          packages: |
            platforms;android-33
            build-tools;33.0.2
            ndk;25.1.8937393

      # ðŸ”‘ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ JAVA_HOME ÐºÐ°Ðº Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð²ÑÐµÐ³Ð¾ job
      - name: Set JAVA_HOME env
        run: echo "JAVA_HOME=${{ runner.tool_cache }}/Java_Temurin-Hotspot_jdk/17.0.17-10/x64" >> $GITHUB_ENV

      # ðŸ”§ ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼ environment.json: Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸ Ð¿Ð¾Ð´ CI
      - name: Patch environment.json for CI
        run: |
          $ndkPath = "C:\Android\android-sdk\ndk\25.1.8937393"
          $sdkPath = "C:\Android\android-sdk"
          $javaPath = "${{ runner.tool_cache }}\Java_Temurin-Hotspot_jdk\17.0.17-10\x64"
          if (Test-Path environment.json) {
            $json = Get-Content environment.json | ConvertFrom-Json
            if ($json.Android) {
              $json.Android.NDK = $ndkPath
              $json.Android.SDK = $sdkPath
              $json.Android.Java = $javaPath
            }
            $json | ConvertTo-Json -Depth 10 | Set-Content environment.json
          }
        shell: pwsh

      - name: Verify tools (CMD)
        shell: cmd
        run: |
          if not exist "BuildToolCpp.exe" exit /b 1
          if not exist "[BUILD]BuildEngine[Android].bat" exit /b 1

      - name: Run Android build script (CMD)
        shell: cmd
        run: |
          call "[BUILD]BuildEngine[Android].bat"

      - name: Find APK
        id: find_apk
        shell: cmd
        run: |
          for /r %%i in (*.apk) do (
            echo APK_PATH=%%i
            echo APK_PATH=%%i>>%GITHUB_ENV%
            goto :done
          )
          echo ERROR: APK not found!
          exit /b 1
          :done

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: game-apk
          path: ${{ env.APK_PATH }}
